# Observers

The module has its own Subject `bfw-sql` (the subject is added to the list `SubjectList` of the framework), who can notify events.
To catch this events, two observers is implemented.
By default, the only events notified is when a request is executed by `Executers`.

All observers implemented can use Monolog.

## Declare an observer

It's on the config file `observers.php`.
You can define all observer to attach to the Subject and monolog loggers to use with him.

Into the config file, you have an array with the key `observers` who contain the list of all observer to define.
Each value of the list should be an array with keys `className` and `monologHandlers`.

Keys definitions :
* `className` : the class name (with namespace) of the observer to define.
* `monologHandlers` : an array who contain monolog handler to attach to this observer
  * `useGlobal` : If the logger used globally for this module (config file `monolog.php`) is used (if used, a clone will be instantiate)
  * `others` : A list of others handlers to attache to the logger (see `monolog.php` config file format to know the format to use)

All Observers, their Loggers (and their handlers) will be instantiate by runners classes when the module is runned by the framework.
You can access to it via the class `SubjectList` who contain the Subject `bfw-sql`, who contains all observers, who contains their monolog Logger.

## Basic

It's the first Observer implemented.
It's catch all request received (user writed and generated by the system)
and log the request and the error status with monolog to the handler defined.

If no monolog handler is defined, the observer will quit before analyze the event.

When an event is received, the method `analyzeUpdate()` analyze the action attached to the event to know what to do.
If the action is `user query`, the method `userQuery()` will be called;
but if the action is `system query`, the method `systemQuery()` will be called.

The method `userQuery()` take the request and error infos from the object passed into the context.
But for the method `systemQuery()`, there is a check if the context contain an `Executers` object.
After that, request and error infos is extract from `Queries` and `Executers` object.

End the method `addQueryToMonoLog()` is called to send the query and error info to monolog.

## Explain

This observer extends Basic observers, so the working is the same.
However, this observer can only be runned with Select generated queries because this observer
execute an EXPLAIN of the query received.

So the method `analyzeUpdate()` never call `userQuery()` method.
And the method `systemQuery()` check also if the Queries object is `Queries\Select`.

Into the method `systemQuery()`, the instance of PDO which be used to execute the original query is take.
And after, into the method `runExplain()`, this instance is used to execute the EXPLAIN query.

At the end, the method `addQueryToMonoLog()` is called and send many infos to monolog.
There are infos about the original request and error info, like for Basic observer.
And there are also all datas returned by explain and the explain error infos (in case of failure).
